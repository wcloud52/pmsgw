<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.saas.biz.mapper.impl.WeixinUserPurseImplMapper">

    <select id="selectByJoin" parameterType="map" resultType="java.util.HashMap">
        SELECT
            id,
            a.openid,
            a.cote_id,
            a.nickname,
            a.pigowner,
            a.bind_name,
            a.bind_tel,
            a.state,
            headimgurl,
            ifnull(money,0) money
        FROM
            (
                SELECT
                    openid,
                    cote_id,
                    pigowner,
                    bind_name,
                    mobile bind_tel,
                    nickname,
                    headimgurl,
                    b.state
                FROM
                    (
                        SELECT
                            pigowner,
                            cote_id,
                            mobile
                        FROM
                            nodejs_mobile_user
                        WHERE
                            cote_id = #{cote_id}
                    ) AS a
                        LEFT JOIN weixin_user AS b ON a.mobile = b.bind_tel
        GROUP BY b.openid

        ORDER BY
                    b.id DESC
            ) AS a
                LEFT JOIN weixin_user_purse AS b ON a.openid = b.openid
        where 1=1
        <if test="customQuerySegment != null and customQuerySegment != '' ">
            and ${customQuerySegment}
        </if>
        <if test="page != null ">
            LIMIT ${page.offset},${page.pageSize}
        </if>
    </select>
    <select id="selectCountByJoin" parameterType="map" resultType="long">
        SELECT count(*)
        FROM
        (
        SELECT
        openid,
        cote_id,
        pigowner,
        bind_name,
        mobile bind_tel,
        nickname,
        headimgurl,
        b.state
        FROM
        (
        SELECT
        pigowner,
        cote_id,
        mobile
        FROM
        nodejs_mobile_user
        WHERE
        cote_id = #{cote_id}
        ) AS a
        LEFT JOIN weixin_user AS b ON a.mobile = b.bind_tel
        GROUP BY b.openid
        ORDER BY
        b.id DESC
        ) AS a
        LEFT JOIN weixin_user_purse AS b ON a.openid = b.openid
        where 1=1
        <if test="customQuerySegment != null and customQuerySegment != '' ">
            and ${customQuerySegment}
        </if>
        <if test="page != null ">
            LIMIT ${page.offset},${page.pageSize}
        </if>
    </select>
</mapper>