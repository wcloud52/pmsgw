/*! Imagetree - v0.1.0 - 2018-05-24
* https://github.com/liuxc0116/imageTree
* Copyright (c) 2018 liuxc; Licensed zrender */
!function(a){function b(a,b){this.own=a,this.parent=b,this.leaf=!1,this.draw_able=!0,this.pos_x=0,this.zr_obj=null}function c(a,b,c,d){this.dom=a,this.pre_level_height=50,this.zr=null,this.total_layers=[],this.animation=!1,"undefined"!=typeof c&&null!=c&&(this.animation=!0),this.draggable=!1,"undefined"!=typeof d&&null!=d&&(this.draggable=!0),this.show_text=null,"undefined"!=typeof b&&null!=b&&(this.show_text=b)}b.prototype={set_parent:function(a){this.parent=a},set_draw_able:function(a){this.draw_able=a},set_leaf:function(a){this.leaf=a},set_position_x:function(a){this.set_pos_x},set_zrender_obj:function(a){this.zr_obj=a},copy:function(){var a=new b(this.own,this.parent);return a.set_draw_able(this.draw_able),a.set_leaf(this.leaf),a.set_position_x(this.pos_x),a.set_zrender_obj(this.zr_obj),a}};var d=function(a){var c=0,d=[],e=[],f=function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.own.id__==b)return!0}return!1},g=function(a){for(var b=0;b<e.length;b++)for(var c=e[b],g=a-1;g<d.length;g++)if(c.level<g&&0==f(d[g],c.node.own.id__)){var h=c.node.copy();h.set_parent(c.node),h.set_draw_able(!1),d[g].push(h)}},h=function(a,f,i){"undefined"==typeof d[i]&&(d[i]=[]);for(var j=0;j<a.length;j++){var k=a[j];k.id__=c++;var l=new b(k,f);k.hasOwnProperty("childrens")?h(k.childrens,l,i+1):(l.set_leaf(!0),e.push({node:l,level:i})),g(i),d[i].push(l)}};return h(a,null,0),d},e=function(b){for(var c=b.layers,d=[],e=function(a,b){if(d=[],b==c.length)return null;for(var e=c[b],f=0,g=0,h=!0,i=0;i<e.length;i++)e[i].parent.own.id__==a&&(1==h&&(f=i,h=!1),1==e[i].draw_able&&d.push(e[i]),g=i);return(e[f].pos_x+e[g].pos_x)/2},f=c.length,g=(b.height-100)/(f-1),h=f-1;h>=0;h--)for(var i=c[h],j=i.length,k=b.width/(j+1),l=0;j>l;l++){var m=i[l],n=e(m.own.id__,h+1);if(null==n&&(n=k*(l+1)),m.pos_x=n,0!=m.draw_able){var o=n-m.own.width/2,p=g*h+m.own.height/2,q=new a.Image({position:[o,p],style:{image:m.own.img_src,width:m.own.width,height:m.own.height},cursor:"pointer",draggable:b.draggable,zlevel:2});b.zr.add(q),m.set_zrender_obj(q);var r=m.own.data,s="";for(var t in r)s+=t+" = "+r[t]+"\n";var u=o+m.own.width+10,v=p+10;console.log(o+","+p),console.log(u+","+v);var w=150;1==m.leaf&&(u=o-w/2+m.own.width/2,v=p+m.own.height/2+10);var x=new a.Text({position:[u,v],style:{text:s,width:w,textFill:"#5d8578",textFont:"10px Microsoft Yahei",textLineHeight:18,rich:{a:{textLineHeight:18}},truncate:{outerWidth:w,ellipsis:"..."}},zlevel:4,draggable:!0}).on("mouseover",function(){this.attr("style",{textFill:"#55a36b",truncate:{}})}).on("mouseout",function(){this.attr("style",{textFill:"#5d8578",truncate:{outerWidth:w,ellipsis:"..."}})}).on("click",function(){null!==b.show_text&&(b.show_text.innerHTML=this.style.text)});if(b.zr.add(x),0==m.leaf)for(var y=0;y<d.length;y++){var z=d[y],A=new a.Line({shape:{x1:q.position[0]+m.own.width/2,y1:q.position[1]+m.own.height/2,x2:z.zr_obj.position[0]+z.own.width/2,y2:z.zr_obj.position[1]+z.own.height/2},style:{fill:"green",stroke:"#4965b0",lineWidth:2},zlevel:1});b.zr.add(A)}}}},f=function(b,c,d,e,g,h,i){var j=c.length;("undefined"==typeof g||null==g)&&(g=b.width),("undefined"==typeof h||null==h)&&(h=1),("undefined"==typeof e||null==e)&&(e=0),"undefined"==typeof i||null==i?i=0:i+=b.pre_level_height;for(var k="undefined"!=typeof d&&null!==d,l=g/j,m=0;j>m;m++){var n=c[m],o=n.hasOwnProperty("childrens"),p=e+l*m+l/2-n.width/2,q=i+n.height/2,r=new a.Image({position:[p,q],style:{image:n.img_src,width:n.width,height:n.height},cursor:"pointer",draggable:b.draggable,zlevel:2});b.zr.add(r);var s=n.data,t="";for(var u in s)t+=u+" = "+s[u]+"\n";var v=p+n.width+10,w=q+10,x=150;o||(v=p-x/2+n.width/2,w=q+n.height/2+10);var y=new a.Text({position:[v,w],style:{text:t,width:x,textFill:"#5d8578",textFont:"10px Microsoft Yahei",textLineHeight:18,rich:{a:{textLineHeight:18}},truncate:{outerWidth:x,ellipsis:"..."}},zlevel:4,draggable:!0}).on("mouseover",function(){this.attr("style",{textFill:"#55a36b",truncate:{}})}).on("mouseout",function(){this.attr("style",{textFill:"#5d8578",truncate:{outerWidth:x,ellipsis:"..."}})}).on("click",function(){null!==b.show_text&&(b.show_text.innerHTML=this.style.text)});if(b.zr.add(y),k){var z=new a.Line({shape:{x1:d.position[0]+d.style.width/2,y1:d.position[1]+d.style.height/2,x2:r.position[0]+r.style.width/2,y2:r.position[1]+r.style.height/2},style:{stroke:"#4965b0",lineWidth:2},zlevel:1});if(b.zr.add(z),b.animation){var A=new a.Circle({position:[z.shape.x1,z.shape.y1],shape:{r:2},style:{fill:"#4965b0",stroke:"#4965b0",lineWidth:1,shadowBlur:10,shadowColor:"#4965b0"},zlevel:3,draggable:!0});b.zr.add(A),b.zr.addHover(A,{fill:"yellow",lineWidth:1,shadowBlur:50,shadowColor:"green",stroke:"green",opacity:1}),b.zr.refresh(),function(a,b){b.animate("",!0).when(3e3,{position:[a.shape.x2,a.shape.y2]}).start()}(z,A)}!function(a,b,c){a.on("mousemove",function(){c.attr("shape",{x1:a.position[0]+a.style.width/2,y1:a.position[1]+a.style.height/2})}),b.on("mousemove",function(){c.attr("shape",{x2:b.position[0]+b.style.width/2,y2:b.position[1]+b.style.height/2})})}(d,r,z)}n.hasOwnProperty("childrens")&&f(b,n.childrens,r,e+l*m,l,h+1,i+n.height)}};c.prototype={init:function(b,c){this.zr=a.init(this.dom,{renderer:"svg"}),this.width=this.zr.getWidth(),this.height=this.zr.getHeight(),"Dichotomy"!=c&&(this.layers=d(b)),console.log(this.layers)},reload:function(a,b){null!=this.zr&&(this.zr.clear(),this.zr=null),this.render(a,b)},render:function(b,c){("undefined"==typeof c||null==c)&&(c="Dichotomy"),null==this.zr&&this.init(b.data,c);var d=new a.Text({position:[10,10],style:{text:b.title,textFill:"black",textFont:"14px Microsoft Yahei"},zlevel:4,draggable:!0});this.zr.add(d),"Dichotomy"==c?f(this,b.data):e(this)}},window.imageTree=c}(zrender);